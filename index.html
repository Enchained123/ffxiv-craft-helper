<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFXIV Craft Helper</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        /* --- 核心变量 --- */
        :root {
            --primary: #4A5D6E;
            --bg-body: #F7F5F0;
            --surface: #FFFFFF;
            --text-dark: #2D2D2D;
            --text-main: #555555;
            --text-sub: #A5A5A5;
            --divider: #EAE8E2;
            --grid-line: rgba(210, 205, 195, 0.4);
            --shadow-paper: 0 2px 10px rgba(0,0,0,0.03);
        }

        * { box-sizing: border-box; }
        body { 
            font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif; 
            background-color: var(--bg-body); color: var(--text-main);
            margin: 0; height: 100vh; display: grid; grid-template-columns: 310px repeat(3, 1fr);
            overflow: hidden; 
            /* 纸张网格背景 */
            background-image: linear-gradient(var(--grid-line) 1px, transparent 1px),
                              linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 25px 25px;
        }

        /* --- 侧边栏 --- */
        aside { 
            padding: 24px; display: flex; flex-direction: column; gap: 20px; 
            height: 100vh; border-right: 1px solid var(--divider); background: #F2F0E9;
        }
        .brand { font-size: 15px; font-weight: 600; color: var(--text-dark); border-bottom: 1px solid var(--text-dark); padding-bottom: 8px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        
        .search-bar-box { background: var(--surface); border: 1px solid #D1CFCA; display: flex; align-items: center; padding: 8px 12px; position: relative; }
        .search-bar-box input { border: none; background: transparent; outline: none; font-size: 13px; width: 100%; }
        
        .dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #D1CFCA; z-index: 200; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .dropdown-item { padding: 10px 12px; font-size: 13px; cursor: pointer; border-bottom: 1px solid var(--divider); }
        .dropdown-item:hover { background: #F9F8F5; }

        .sidebar-card { flex: 1; display: flex; flex-direction: column; overflow: hidden; border: 1px solid #D1CFCA; background: var(--surface); box-shadow: var(--shadow-paper); }
        .card-header-label { padding: 12px 15px; font-size: 12px; font-weight: bold; color: var(--text-dark); background: #FAF9F6; border-bottom: 1px solid var(--divider); display: flex; justify-content: space-between; align-items: center; }

        .scroll-list { flex: 1; overflow-y: auto; padding: 0 15px; }
        
        /* --- 列表项交互 --- */
        .list-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 0; border-bottom: 1px solid var(--divider); 
            font-size: 13px; transition: opacity 0.2s, background 0.2s;
            background: white; user-select: none;
        }
        .list-item:hover { background: #FCFBFA; }
        .list-item:active { transform: scale(0.995); }

        .checkbox-wrapper { margin-right: 12px; display: flex; align-items: center; cursor: pointer; padding: 2px; }
        .custom-checkbox {
            width: 18px; height: 18px; border: 1.5px solid #D1CFCA; border-radius: 4px;
            display: flex; align-items: center; justify-content: center; background: white;
            transition: all 0.2s;
        }
        .custom-checkbox i { font-size: 15px; color: white; display: none; }
        
        .item-name-text { flex: 1; padding-right: 8px; cursor: pointer; line-height: 1.4; }
        
        /* 状态样式 */
        .is-done { opacity: 0.3; }
        .is-done .item-name-text { text-decoration: line-through; }
        .is-done .custom-checkbox { background: var(--primary); border-color: var(--primary); }
        .is-done .custom-checkbox i { display: block; }
        .is-done .minimal-input { visibility: hidden; }

        /* 快速导入 */
        .import-box-inner { padding: 15px; border-top: 1px solid var(--divider); display: flex; flex-direction: column; gap: 8px; background: #FAF9F6; }
        .inner-select { border: 1px solid #D1CFCA; padding: 6px; font-size: 12px; outline: none; width: 100%; }
        .inner-btn { background: #4A4A4A; color: #fff; border: none; padding: 8px; font-size: 12px; font-weight: bold; cursor: pointer; border-radius: 2px; }

        /* 右侧布局 */
        .col-wrapper { padding: 20px 10px; display: flex; flex-direction: column; height: 100vh; position: relative; visibility: hidden; opacity: 0; transition: 0.3s; }
        .col-wrapper.active { visibility: visible; opacity: 1; }
        
        .big-card { background: var(--surface); border: 1px solid #D1CFCA; display: flex; flex-direction: column; flex: 1; box-shadow: var(--shadow-paper); position: relative; overflow: hidden; }
        /* 左侧模拟装订孔效果 */
        .big-card::after { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background-image: radial-gradient(#EAE8E2 1.5px, transparent 1.5px); background-size: 4px 20px; }

        .section-title { font-size: 10px; font-weight: 700; padding: 6px 15px; border-bottom: 1px solid var(--divider); color: var(--text-sub); background: #FDFDFB; text-transform: uppercase; }
        
        .qty-group { display: flex; align-items: center; gap: 4px; }
        .minimal-input { width: 40px; border: none; text-align: right; font-size: 13px; font-weight: 600; outline: none; background: #F9F8F5; border-radius: 4px; padding: 2px; }
        .target-qty-right { font-weight: 700; min-width: 25px; text-align: right; color: var(--text-dark); }
        
        .crystal-card { flex: 0 0 auto; height: 35%; margin-top: 15px; }
        .tag-currency { font-size: 9px; color: #8430ce; background: #f3e8fd; padding: 1px 4px; border-radius: 3px; margin-top: 2px; display: inline-block; }
        .currency-footer { padding: 12px 15px; background: #FAF9F6; border-top: 1px solid var(--divider); font-size: 12px; }

        .mini-toggle { display: flex; align-items: center; gap: 6px; font-size: 10px; cursor: pointer; }
        .mini-toggle input { display: none; }
        .toggle-rail { width: 24px; height: 14px; background: #D1CFCA; border-radius: 7px; position: relative; }
        .toggle-rail::after { content: ''; position: absolute; top: 2px; left: 2px; width: 10px; height: 10px; background: white; border-radius: 50%; transition: 0.2s; }
        input:checked + .toggle-rail { background: var(--primary); }
        input:checked + .toggle-rail::after { transform: translateX(10px); }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #E0DDD5; }
    </style>
</head>
<body>

<aside>
    <div class="brand"><i class="material-icons-round" style="font-size:18px;">auto_awesome</i><span>FFXIV Craft Helper</span></div>
    
    <div class="search-bar-box">
        <i class="material-icons-round" style="font-size: 16px; color:var(--text-sub);">search</i>
        <input type="text" id="searchInput" placeholder="搜索配方..." autocomplete="off">
        <div id="searchDropdown" class="dropdown"></div>
    </div>

    <div class="sidebar-card">
        <div class="card-header-label">
            <span>当前计划</span>
            <span style="cursor:pointer; font-weight: normal; font-size:10px; text-decoration: underline;" onclick="clearCart()">RESET</span>
        </div>
        <div class="scroll-list" id="cartList"></div>
        
        <div class="import-box-inner">
            <select id="catSelect" class="inner-select" onchange="handleCategoryChange()">
                <option value="">-- 分类 --</option>
            </select>
            <select id="setSelect" class="inner-select" disabled>
                <option value="">-- 职业 --</option>
            </select>
            <button class="inner-btn" onclick="addSelectedSet()">添加套装</button>
        </div>
    </div>
</aside>

<div class="col-wrapper right-col">
    <div class="big-card">
        <div class="card-header-label">成品清单</div>
        <div class="section-title">Step 01: Final Goods</div>
        <div class="scroll-list" id="directList"></div>
    </div>
</div>

<div class="col-wrapper right-col">
    <div class="big-card">
        <div class="card-header-label">中间件清单</div>
        <div class="section-title">Step 02: Intermediate</div>
        <div class="scroll-list" id="subList"></div>
    </div>
    <div class="big-card crystal-card">
        <div class="card-header-label">
            <span>能量消耗</span>
            <label class="mini-toggle">
                <span>忽略</span>
                <input type="checkbox" id="crystalIgnoreToggle" checked onchange="calculateAll()">
                <div class="toggle-rail"></div>
            </label>
        </div>
        <div class="scroll-list" id="crystalList"></div>
    </div>
</div>

<div class="col-wrapper right-col">
    <div class="big-card">
        <div class="card-header-label">基础素材清单</div>
        <div class="section-title">Step 03: Raw Materials</div>
        <div class="scroll-list" id="rawList"></div>
        <div id="currencyFooter" class="currency-footer" style="display:none">
            <div id="currencyList"></div>
        </div>
    </div>
</div>

<script>
    let allRecipes = [], recipeMap = {}, gearSets = [], currencyMap = {}, cart = [], inventory = {};
    const crystalKeywords = ['之碎晶', '之水晶', '之晶簇', 'Shard', 'Crystal', 'Cluster'];
    const isCrystal = (n) => crystalKeywords.some(k => n.includes(k));

    // 双击复制功能
    async function copyName(name) {
        try {
            await navigator.clipboard.writeText(name);
        } catch (err) {
            console.error('无法复制', err);
        }
    }

    // 数据加载
    Promise.all([
        fetch('recipes.json').then(r => r.json()).catch(() => []),
        fetch('gear_sets.json').then(r => r.json()).catch(() => []),
        fetch('currency.json').then(r => r.json()).catch(() => ({}))
    ]).then(([recipes, sets, currencies]) => {
        allRecipes = recipes; gearSets = sets; currencyMap = currencies;
        recipes.forEach(r => { recipeMap[String(r.result_id)] = r; recipeMap[r.name.trim()] = r; });
        initCategorySelect();
    });

    function calculateAll() {
        const totalDirect = {}, totalSub = {}, totalRaw = {}, totalCrystals = {}, totalCurrency = {};
        const ignoreCrystals = document.getElementById('crystalIgnoreToggle').checked;
        const rightCols = document.querySelectorAll('.right-col');
        
        if (cart.length > 0) rightCols.forEach(el => el.classList.add('active'));
        else rightCols.forEach(el => el.classList.remove('active'));

        cart.forEach(cartItem => {
            const recipe = recipeMap[String(cartItem.result_id)];
            if (!recipe) return;
            const crafts = Math.ceil(cartItem.amount / recipe.amount);
            recipe.ingredients.forEach(ing => {
                if (isCrystal(ing.name)) totalCrystals[ing.name] = (totalCrystals[ing.name] || 0) + (ing.amount * crafts);
                else { 
                    if (!totalDirect[ing.name]) totalDirect[ing.name] = { amount: 0, id: ing.id }; 
                    totalDirect[ing.name].amount += (ing.amount * crafts); 
                }
            });
        });

        for (let name in totalDirect) {
            const item = totalDirect[name], owned = inventory[name.trim()] || 0, remaining = Math.max(0, item.amount - owned);
            const subRecipe = recipeMap[String(item.id)];
            if (subRecipe && remaining > 0) {
                const crafts = Math.ceil(remaining / subRecipe.amount);
                subRecipe.ingredients.forEach(ing => solveChainRecursive(ing.id, ing.amount * crafts, totalSub, totalRaw, totalCrystals, ing.name));
            } else if (!subRecipe && remaining > 0) {
                if (!totalRaw[name]) totalRaw[name] = { amount: 0, id: item.id };
                totalRaw[name].amount += remaining;
            }
        }

        for (let name in totalRaw) {
            const cn = name.trim();
            if (currencyMap[cn]) totalCurrency[currencyMap[cn].name] = (totalCurrency[currencyMap[cn].name] || 0) + (currencyMap[cn].price * totalRaw[name].amount);
        }

        renderList('directList', totalDirect);
        renderList('subList', totalSub);
        renderList('rawList', totalRaw);
        renderCrystalList(totalCrystals, ignoreCrystals);
        renderCurrencyFooter(totalCurrency);
    }

    function solveChainRecursive(itemId, need, subMap, rawMap, cryMap, itemName) {
        if (isCrystal(itemName)) { cryMap[itemName] = (cryMap[itemName] || 0) + need; return; }
        const owned = inventory[itemName.trim()] || 0, recipe = recipeMap[String(itemId)];
        if (recipe) {
            if(!subMap[itemName]) subMap[itemName] = { amount: 0, id: itemId };
            subMap[itemName].amount += need;
            const netNeed = Math.max(0, need - owned);
            if (netNeed > 0) {
                const crafts = Math.ceil(netNeed / recipe.amount);
                recipe.ingredients.forEach(ing => solveChainRecursive(ing.id, ing.amount * crafts, subMap, rawMap, cryMap, ing.name));
            }
        } else { if(!rawMap[itemName]) rawMap[itemName] = { amount: 0, id: itemId }; rawMap[itemName].amount += need; }
    }

    function renderList(id, data) {
        const container = document.getElementById(id); container.innerHTML = '';
        Object.keys(data).sort((a,b) => ((inventory[a.trim()]||0) >= data[a].amount) - ((inventory[b.trim()]||0) >= data[b].amount)).forEach(name => {
            const needed = data[name].amount, owned = inventory[name.trim()] || 0, isDone = owned >= needed;
            const cur = currencyMap[name.trim()];
            const curTag = cur ? `<div class="tag-currency">${cur.price} ${cur.name}</div>` : '';

            const itemEl = document.createElement('div');
            itemEl.className = `list-item ${isDone ? 'is-done' : ''}`;
            itemEl.ondblclick = () => copyName(name);

            itemEl.innerHTML = `
                <div class="checkbox-wrapper" onclick="event.stopPropagation(); updateInv('${name}', ${isDone ? 0 : needed})">
                    <div class="custom-checkbox"><i class="material-icons-round">done</i></div>
                </div>
                <div class="item-name-text">
                    <div style="font-weight:500">${name}</div>
                    ${curTag}
                </div>
                <div class="qty-group">
                    <input type="number" class="minimal-input" value="${owned}" 
                        onclick="event.stopPropagation()" onfocus="this.select()"
                        onchange="updateInv('${name}', this.value)">
                    <span style="color:#CCC; font-size:11px;">/</span>
                    <span class="target-qty-right">${needed}</span>
                </div>
            `;
            container.appendChild(itemEl);
        });
    }

    function renderCrystalList(data, ignore) {
        const container = document.getElementById('crystalList'); container.innerHTML = '';
        Object.keys(data).sort((a,b) => ((inventory[a.trim()]||0) >= data[a]) - ((inventory[b.trim()]||0) >= data[b])).forEach(name => {
            const needed = data[name], owned = inventory[name.trim()] || 0, isDone = ignore || (owned >= needed);
            const itemEl = document.createElement('div');
            itemEl.className = `list-item ${isDone ? 'is-done' : ''}`;
            itemEl.ondblclick = () => copyName(name);

            itemEl.innerHTML = `
                <div class="checkbox-wrapper" onclick="event.stopPropagation(); updateInv('${name}', ${isDone && !ignore ? 0 : needed})">
                    <div class="custom-checkbox"><i class="material-icons-round">bolt</i></div>
                </div>
                <span class="item-name-text">${name}</span>
                <div class="qty-group">
                    <input type="number" class="minimal-input" value="${owned}" 
                        onclick="event.stopPropagation()" onfocus="this.select()"
                        onchange="updateInv('${name}', this.value)">
                    <span style="color:#CCC; font-size:11px;">/</span>
                    <span class="target-qty-right">${needed}</span>
                </div>
            `;
            container.appendChild(itemEl);
        });
    }

    function updateInv(name, val) { inventory[name.trim()] = Math.max(0, parseInt(val) || 0); calculateAll(); }
    
    function renderCart() {
        const c = document.getElementById('cartList'); c.innerHTML = '';
        if (cart.length === 0) { c.innerHTML = '<div style="text-align:center; margin-top:40px; color:#bdc1c6; font-size:11px;">( 暂无计划 )</div>'; return; }
        cart.forEach((item, i) => {
            const r = recipeMap[String(item.result_id)];
            const div = document.createElement('div'); div.className = 'list-item'; div.style.padding = "8px 0";
            div.innerHTML = `<div style="font-size:12px; flex:1;">${r.name}</div>
                <div style="display:flex; align-items:center; gap:8px;">
                    <span style="cursor:pointer" onclick="updateCart(${i},-1)">-</span>
                    <b style="min-width:15px; text-align:center;">${item.amount}</b>
                    <span style="cursor:pointer" onclick="updateCart(${i},1)">+</span>
                </div>`;
            c.appendChild(div);
        });
    }

    function updateCart(i, d) { cart[i].amount += d; if(cart[i].amount <=0) cart.splice(i,1); calculateAll(); renderCart(); }
    function clearCart() { if(confirm("确定清空计划？")) { cart = []; inventory = {}; calculateAll(); renderCart(); } }

    function renderCurrencyFooter(data) {
        const f = document.getElementById('currencyFooter'), l = document.getElementById('currencyList');
        if (Object.keys(data).length === 0) { f.style.display = 'none'; return; }
        f.style.display = 'block'; l.innerHTML = '<div style="font-size:10px;color:#999;margin-bottom:5px;font-weight:bold;">ESTIMATED COST</div>';
        for (let n in data) l.innerHTML += `<div style="display:flex; justify-content:space-between"><span>${n}</span><b>${data[n]}</b></div>`;
    }

    document.getElementById('searchInput').oninput = function() {
        const v = this.value.trim(), d = document.getElementById('searchDropdown'); d.innerHTML = '';
        if(!v) { d.style.display='none'; return; }
        allRecipes.filter(r => r.name.includes(v)).slice(0,10).forEach(r => {
            const div = document.createElement('div'); div.className = 'dropdown-item'; div.innerText = r.name;
            div.onclick = () => { 
                const exist = cart.find(i => i.result_id === r.result_id); 
                if (exist) exist.amount++; else cart.push({ result_id: r.result_id, amount: 1 }); 
                d.style.display='none'; this.value=''; calculateAll(); renderCart(); 
            };
            d.appendChild(div);
        });
        d.style.display='block';
    }

    function initCategorySelect() { 
        const catS = document.getElementById('catSelect');
        gearSets.forEach((c, i) => { const o = document.createElement('option'); o.value = i; o.text = c.category; catS.add(o); }); 
    }
    function handleCategoryChange() {
        const idx = document.getElementById('catSelect').value, s = document.getElementById('setSelect');
        s.innerHTML = '<option value="">-- 选择职业 --</option>';
        if (idx==="") { s.disabled=true; return; }
        gearSets[idx].sets.forEach((set, i) => { const o = document.createElement('option'); o.value = `${idx}-${i}`; o.text = set.name; s.add(o); });
        s.disabled = false;
    }
    function addSelectedSet() {
        const v = document.getElementById('setSelect').value; if (!v) return;
        const [c, s] = v.split('-').map(Number);
        gearSets[c].sets[s].items.forEach(name => {
            const r = allRecipes.find(rec => rec.name.trim() === name.trim());
            if (r) { const exist = cart.find(i => i.result_id === r.result_id); if (exist) exist.amount++; else cart.push({ result_id: r.result_id, amount: 1 }); }
        });
        calculateAll(); renderCart();
    }
</script>
</body>
</html>

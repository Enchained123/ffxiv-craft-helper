<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFXIV Craft Helper</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        /* --- 核心变量 (严格保留) --- */
        :root {
            --primary: #1a73e8;
            --bg-body: #f8f9fa; 
            --surface: #ffffff;
            --text-dark: #222222;
            --text-main: #3c4043;
            --text-sub: #70757a;
            --text-grey-light: #E0E0E0; 
            --text-input: #5F6368;      
            --divider: #f2f2f2; 
            --radius-large: 32px;
            --radius-inner: 20px;
            --border-light: #dadce0;
            --currency-bg: #f3e8fd;
            --currency-text: #8430ce;
            --success: #34a853;
        }

        * { box-sizing: border-box; }
        body { 
            font-family: 'Google Sans', 'SF Pro Display', 'Microsoft YaHei', sans-serif; 
            background-color: var(--bg-body); color: var(--text-main);
            margin: 0; height: 100vh; display: grid; grid-template-columns: repeat(4, 1fr); overflow: hidden; 
        }

        /* --- 侧边栏 --- */
        aside { padding: 24px 12px 24px 24px; display: flex; flex-direction: column; gap: 16px; height: 100vh; }
        .brand { padding: 0 8px; font-size: 18px; font-weight: 600; color: var(--text-dark); display: flex; align-items: center; gap: 10px; }
        .brand i { color: var(--text-dark); font-size: 24px; }
        .search-bar-box { border: 1px solid var(--border-light); border-radius: 20px; display: flex; align-items: center; padding: 8px 16px; transition: 0.2s; }
        .search-bar-box:focus-within { border-color: var(--primary); background: white; }
        .search-bar-box input { border: none; background: transparent; outline: none; margin-left: 8px; font-size: 14px; width: 100%; }

        .sidebar-card { background: var(--surface); border-radius: var(--radius-large); box-shadow: 0 1px 3px rgba(0,0,0,0.03); flex: 1; display: flex; flex-direction: column; overflow: hidden; border: 1px solid rgba(0,0,0,0.05); }
        .card-header-label { padding: 24px 24px 8px; display: flex; justify-content: space-between; align-items: center; font-size: 13px; font-weight: 400; color: var(--text-sub); }

        .scroll-list { flex: 1; overflow-y: auto; padding: 0 24px; display: flex; flex-direction: column; }
        .scroll-list::-webkit-scrollbar { width: 0; }

        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 0.5px solid var(--divider); font-size: 14px; background: white; }
        .list-item:last-child { border-bottom: none; }
        .item-name-sidebar { font-size: 14px; font-weight: 400; color: var(--text-dark); flex: 1; padding-right: 8px; }

        .stepper { display: flex; align-items: center; gap: 6px; background: var(--bg-body); padding: 2px 4px; border-radius: 8px; transform: scale(0.85); transform-origin: right center; }
        .btn-step { width: 20px; height: 20px; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: var(--text-sub); cursor: pointer; }
        .btn-step:hover { background: white; color: var(--text-dark); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .qty-sb { font-size: 12px; font-weight: 700; min-width: 14px; text-align: center; }

        .import-box-inner { background: #f8f9fa; margin: 10px 16px 16px; padding: 16px; border-radius: var(--radius-inner); display: flex; flex-direction: column; gap: 10px; }
        .inner-select { background: white; border: 1px solid #eee; padding: 8px; border-radius: 10px; font-size: 12px; outline: none; cursor: pointer; color: var(--text-main); }
        .inner-btn { background: var(--text-dark); color: white; border: none; padding: 10px; border-radius: 10px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }

        /* --- 右侧布局 --- */
        .col-wrapper { padding: 24px 24px 24px 12px; display: flex; flex-direction: column; gap: 24px; height: 100vh; overflow-y: auto; visibility: hidden; opacity: 0; transition: opacity 0.3s; }
        .col-wrapper.active { visibility: visible; opacity: 1; }
        .col-fixed { height: 100vh; overflow: hidden; }
        .big-card { background: var(--surface); border-radius: var(--radius-large); box-shadow: 0 1px 3px rgba(0,0,0,0.03); display: flex; flex-direction: column; border: 1px solid rgba(0,0,0,0.05); width: 100%; }
        .full-height { flex: 1; overflow: hidden; }

        /* --- 极简数字输入逻辑 (优化版) --- */
        .qty-group { display: flex; align-items: center; justify-content: flex-end; gap: 4px; min-width: 80px; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        .minimal-input { 
            width: 45px; border: none; background: transparent; 
            text-align: right; font-size: 14px; font-weight: 600; 
            outline: none; padding: 4px 6px; border-radius: 6px; 
            transition: color 0.1s, background 0.2s;
        }
        .minimal-input:hover, .minimal-input:focus { background: #f0f0f0; }
        
        .val-empty { color: var(--text-grey-light); } /* 0色 */
        .val-filled { color: var(--text-input); }      /* 输入后色 */
        
        .slash { color: var(--text-grey-light); font-size: 12px; margin: 0 2px; }
        .target-qty-right { font-weight: 600; color: var(--text-sub); min-width: 25px; text-align: right; font-size: 14px; }

        /* 状态样式 */
        .is-ready { font-weight: 500 !important; color: var(--text-dark) !important; }
        .is-done { opacity: 0.3 !important; text-decoration: line-through !important; order: 999 !important; background: transparent !important; }
        .is-done .minimal-input { visibility: hidden; }

        /* 货币与开关 */
        .tag-currency { font-size: 10px; color: var(--currency-text); background: var(--currency-bg); padding: 1px 6px; border-radius: 4px; margin-top: 3px; display: inline-block; width: fit-content; }
        .currency-footer { padding: 15px 24px; background: #fdfdfd; border-top: 1px solid var(--divider); border-radius: 0 0 32px 32px; }
        .currency-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; color: var(--currency-text); }
        .mini-toggle { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-sub); cursor: pointer; }
        .mini-toggle input { display: none; }
        .toggle-rail { width: 28px; height: 16px; background: #eee; border-radius: 10px; position: relative; transition: 0.3s; }
        .toggle-rail::after { content: ''; position: absolute; top: 2px; left: 2px; width: 12px; height: 12px; background: white; border-radius: 50%; transition: 0.3s; }
        input:checked + .toggle-rail { background: var(--text-dark); }
        input:checked + .toggle-rail::after { transform: translateX(12px); }

        .dropdown { position: absolute; top: 120px; left: 24px; right: 24px; background: white; border: 1px solid var(--border-light); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-height: 250px; overflow-y: auto; display: none; z-index: 100; }
        .dropdown-item { padding: 12px 16px; cursor: pointer; font-size: 13px; }
        .dropdown-item:hover { background: var(--bg-body); color: var(--primary); }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #dadce0; border-radius: 2px; }
    </style>
</head>
<body>

<aside>
    <div class="brand"><i class="material-icons-round">auto_awesome</i><span>FFXIV Craft Helper</span></div>
    <div class="search-bar-box">
        <i class="material-icons-round" style="color:#999; font-size: 18px;">search</i>
        <input type="text" id="searchInput" placeholder="搜索配方..." autocomplete="off">
        <div id="searchDropdown" class="dropdown"></div>
    </div>
    <div class="sidebar-card">
        <div class="card-header-label">
            <span>当前计划</span>
            <span style="color:var(--text-dark); cursor:pointer; font-weight:500;" onclick="clearCart()">清空</span>
        </div>
        <div class="scroll-list" id="cartList"></div>
        <div class="import-box-inner">
            <div style="font-size:11px; font-weight:600; color:#aaa; text-transform:uppercase; letter-spacing:0.5px;">快速导入套装</div>
            <select id="catSelect" class="inner-select" onchange="handleCategoryChange()"><option value="">-- 分类 --</option></select>
            <select id="setSelect" class="inner-select" disabled><option value="">-- 职业 --</option></select>
            <button class="inner-btn" onclick="addSelectedSet()"><i class="material-icons-round" style="font-size:16px;">add</i>添加套装</button>
        </div>
    </div>
</aside>

<div class="col-wrapper col-fixed right-col">
    <div class="big-card full-height">
        <div class="card-header-label">一级材料</div>
        <div class="scroll-list" id="directList"></div>
    </div>
</div>

<div class="col-wrapper right-col">
    <div class="big-card">
        <div class="card-header-label">二级材料</div>
        <div class="scroll-list" style="overflow:visible;" id="subList"></div>
    </div>
    <div class="big-card">
        <div class="card-header-label">
            <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                <span>水晶消耗</span>
                <label class="mini-toggle">
                    <span>自动满足</span>
                    <input type="checkbox" id="crystalIgnoreToggle" checked onchange="calculateAll()">
                    <div class="toggle-rail"></div>
                </label>
            </div>
        </div>
        <div class="scroll-list" style="overflow:visible;" id="crystalList"></div>
    </div>
</div>

<div class="col-wrapper col-fixed right-col">
    <div class="big-card full-height">
        <div class="card-header-label">三级材料</div>
        <div class="scroll-list" id="rawList"></div>
        <div id="currencyFooter" class="currency-footer" style="display:none"><div id="currencyList"></div></div>
    </div>
</div>

<script>
    let allRecipes = [], recipeMap = {}, gearSets = [], currencyMap = {}, cart = [], inventory = {};
    const crystalKeywords = ['之碎晶', '之水晶', '之晶簇', 'Shard', 'Crystal', 'Cluster'];
    const isCrystal = (n) => crystalKeywords.some(k => n.includes(k));

    Promise.all([
        fetch('recipes.json').then(r => r.json()),
        fetch('gear_sets.json').then(r => r.json()).catch(() => []),
        fetch('currency.json').then(r => r.json()).catch(() => ({}))
    ]).then(([recipes, sets, currencies]) => {
        allRecipes = recipes; gearSets = sets; currencyMap = currencies;
        recipes.forEach(r => { recipeMap[String(r.result_id)] = r; recipeMap[r.name.trim()] = r; });
        initCategorySelect();
    });

    function calculateAll() {
        const totalDirect = {}, totalSub = {}, totalRaw = {}, totalCrystals = {}, totalCurrency = {};
        const ignoreCrystals = document.getElementById('crystalIgnoreToggle').checked;
        const rightCols = document.querySelectorAll('.right-col');
        if (cart.length > 0) rightCols.forEach(el => el.classList.add('active'));
        else rightCols.forEach(el => el.classList.remove('active'));

        cart.forEach(cartItem => {
            const recipe = recipeMap[String(cartItem.result_id)];
            if (!recipe) return;
            const crafts = Math.ceil(cartItem.amount / recipe.amount);
            recipe.ingredients.forEach(ing => {
                if (isCrystal(ing.name)) totalCrystals[ing.name] = (totalCrystals[ing.name] || 0) + (ing.amount * crafts);
                else { if (!totalDirect[ing.name]) totalDirect[ing.name] = { amount: 0, id: ing.id }; totalDirect[ing.name].amount += (ing.amount * crafts); }
            });
        });

        for (let name in totalDirect) {
            const item = totalDirect[name], owned = inventory[name.trim()] || 0, remaining = Math.max(0, item.amount - owned);
            const subRecipe = recipeMap[String(item.id)];
            if (subRecipe && remaining > 0) {
                const crafts = Math.ceil(remaining / subRecipe.amount);
                subRecipe.ingredients.forEach(ing => solveChainRecursive(ing.id, ing.amount * crafts, totalSub, totalRaw, totalCrystals, ing.name));
            } else if (!subRecipe && remaining > 0) {
                if (!totalRaw[name]) totalRaw[name] = { amount: 0, id: item.id };
                totalRaw[name].amount += remaining;
            }
        }

        for (let name in totalRaw) {
            const cn = name.trim();
            if (currencyMap[cn]) totalCurrency[currencyMap[cn].name] = (totalCurrency[currencyMap[cn].name] || 0) + (currencyMap[cn].price * totalRaw[name].amount);
        }

        renderList('directList', totalDirect);
        renderList('subList', totalSub);
        renderList('rawList', totalRaw);
        renderCrystalList(totalCrystals, ignoreCrystals);
        renderCurrencyFooter(totalCurrency);
    }

    function solveChainRecursive(itemId, need, subMap, rawMap, cryMap, itemName) {
        if (isCrystal(itemName)) { cryMap[itemName] = (cryMap[itemName] || 0) + need; return; }
        const owned = inventory[itemName.trim()] || 0, recipe = recipeMap[String(itemId)];
        if (recipe) {
            if(!subMap[itemName]) subMap[itemName] = { amount: 0, id: itemId };
            subMap[itemName].amount += need;
            const netNeed = Math.max(0, need - owned);
            if (netNeed > 0) {
                const crafts = Math.ceil(netNeed / recipe.amount);
                recipe.ingredients.forEach(ing => solveChainRecursive(ing.id, ing.amount * crafts, subMap, rawMap, cryMap, ing.name));
            }
        } else { if(!rawMap[itemName]) rawMap[itemName] = { amount: 0, id: itemId }; rawMap[itemName].amount += need; }
    }

    // --- 核心渲染函数：更新输入框交互逻辑 ---
    function renderList(id, data) {
        const container = document.getElementById(id); container.innerHTML = '';
        Object.keys(data).sort((a,b) => ((inventory[a.trim()]||0) >= data[a].amount) - ((inventory[b.trim()]||0) >= data[b].amount)).forEach(name => {
            const needed = data[name].amount, owned = inventory[name.trim()] || 0, isDone = owned >= needed, isReady = checkReady(name, needed);
            const inputClass = owned > 0 ? 'val-filled' : 'val-empty';
            const div = document.createElement('div');
            div.className = `list-item ${isDone ? 'is-done' : ''} ${isReady && !isDone ? 'is-ready' : ''}`;
            
            const cur = currencyMap[name.trim()];
            const curTag = cur ? `<div class="tag-currency">${cur.price} ${cur.name}</div>` : '';

            div.innerHTML = `<div style="display:flex; flex-direction:column;">
                <div style="display:flex;align-items:center;">${isDone ? '<i class="material-icons-round" style="font-size:16px;color:var(--success);margin-right:4px;">check_circle</i>' : ''}<span>${name}</span></div>
                ${curTag}
            </div>
            <div class="qty-group">
                <input type="number" 
                       class="minimal-input ${inputClass}" 
                       value="${owned}" 
                       onfocus="this.select()"
                       oninput="this.classList.toggle('val-filled', this.value > 0); this.classList.toggle('val-empty', this.value <= 0)"
                       onchange="updateInv('${name}', this.value)" 
                       onclick="event.stopPropagation()">
                <span class="slash">/</span>
                <span class="target-qty-right">${needed}</span>
            </div>`;
            div.onclick = () => updateInv(name, isDone ? 0 : needed);
            container.appendChild(div);
        });
    }

    function renderCrystalList(data, ignore) {
        const container = document.getElementById('crystalList'); container.innerHTML = '';
        Object.keys(data).sort((a,b) => ((inventory[a.trim()]||0) >= data[a]) - ((inventory[b.trim()]||0) >= data[b])).forEach(name => {
            const needed = data[name], owned = inventory[name.trim()] || 0, isDone = ignore || (owned >= needed);
            const div = document.createElement('div');
            div.className = `list-item ${isDone ? 'is-done' : ''}`;
            div.innerHTML = `<span>${name}</span>
                <div class="qty-group">
                    <input type="number" 
                           class="minimal-input ${owned > 0 ? 'val-filled' : 'val-empty'}" 
                           value="${owned}" 
                           onfocus="this.select()"
                           oninput="this.classList.toggle('val-filled', this.value > 0); this.classList.toggle('val-empty', this.value <= 0)"
                           onchange="updateInv('${name}', this.value)" 
                           onclick="event.stopPropagation()">
                    <span class="slash">/</span>
                    <span class="target-qty-right">${needed}</span>
                </div>`;
            div.onclick = () => updateInv(name, isDone && !ignore ? 0 : needed);
            container.appendChild(div);
        });
    }

    function checkReady(name, needed) {
        const recipe = recipeMap[name.trim()]; if (!recipe) return false;
        const ignore = document.getElementById('crystalIgnoreToggle').checked;
        const rounds = Math.ceil(needed / recipe.amount);
        return recipe.ingredients.every(ing => (ignore && isCrystal(ing.name)) || (inventory[ing.name.trim()] || 0) >= (ing.amount * rounds));
    }

    function updateInv(name, val) { inventory[name.trim()] = Math.max(0, parseInt(val) || 0); calculateAll(); }
    function clearCart() { if(confirm("确定清空当前计划吗？")) { cart = []; calculateAll(); renderCart(); } }
    function renderCurrencyFooter(data) {
        const f = document.getElementById('currencyFooter'), l = document.getElementById('currencyList');
        if (Object.keys(data).length === 0) { f.style.display = 'none'; return; }
        f.style.display = 'block'; l.innerHTML = '<div style="font-size:11px;color:#999;margin-bottom:5px;text-transform:uppercase;letter-spacing:0.5px;">货币消耗统计</div>';
        for (let n in data) l.innerHTML += `<div class="currency-row"><span>${n}</span><b style="font-weight:700;">${data[n]}</b></div>`;
    }
    function initCategorySelect() { gearSets.forEach((c, i) => { const o = document.createElement('option'); o.value = i; o.text = c.category; document.getElementById('catSelect').add(o); }); }
    function handleCategoryChange() {
        const idx = document.getElementById('catSelect').value, s = document.getElementById('setSelect');
        s.innerHTML = '<option value="">-- 选择职业 --</option>';
        if (idx==="") { s.disabled=true; return; }
        gearSets[idx].sets.forEach((set, i) => { const o = document.createElement('option'); o.value = `${idx}-${i}`; o.text = set.name; s.add(o); });
        s.disabled = false;
    }
    function addSelectedSet() {
        const v = document.getElementById('setSelect').value; if (!v) return;
        const [c, s] = v.split('-').map(Number);
        gearSets[c].sets[s].items.forEach(name => {
            const r = allRecipes.find(rec => rec.name.trim() === name.trim());
            if (r) { const exist = cart.find(i => i.result_id === r.result_id); if (exist) exist.amount++; else cart.push({ result_id: r.result_id, amount: 1 }); }
        });
        calculateAll(); renderCart();
    }
    function renderCart() {
        const c = document.getElementById('cartList'); c.innerHTML = '';
        if (cart.length === 0) { c.innerHTML = '<div style="text-align:center; margin-top:40px; color:#bdc1c6; font-size:12px;">暂无计划</div>'; return; }
        cart.forEach((item, i) => {
            const r = recipeMap[String(item.result_id)];
            const div = document.createElement('div'); div.className = 'list-item';
            div.innerHTML = `<div class="item-name-sidebar">${r.name}</div><div class="stepper"><div class="btn-step" onclick="updateCart(${i},-1)">－</div><div class="qty-sb">${item.amount}</div><div class="btn-step" onclick="updateCart(${i},1)">＋</div></div>`;
            c.appendChild(div);
        });
    }
    function updateCart(i, d) { cart[i].amount += d; if(cart[i].amount <=0) cart.splice(i,1); calculateAll(); renderCart(); }
    document.getElementById('searchInput').oninput = function() {
        const v = this.value.trim(), d = document.getElementById('searchDropdown'); d.innerHTML = '';
        if(!v) { d.style.display='none'; return; }
        allRecipes.filter(r => r.name.includes(v)).slice(0,8).forEach(r => {
            const div = document.createElement('div'); div.className = 'dropdown-item'; div.innerText = r.name;
            div.onclick = () => { const exist = cart.find(i => i.result_id === r.result_id); if (exist) exist.amount++; else cart.push({ result_id: r.result_id, amount: 1 }); d.style.display='none'; this.value=''; calculateAll(); renderCart(); };
            d.appendChild(div);
        });
        d.style.display='block';
    }
</script>
</body>
</html>

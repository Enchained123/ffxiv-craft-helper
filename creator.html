<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>FFXIV Gear Set Architect</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root {
            --primary: #1967d2;
            --bg-body: #f8f9fa;
            --surface: #ffffff;
            --border: #dadce0;
            --text-main: #202124;
            --text-sub: #5f6368;
            --hover: #f1f3f4;
            --success: #188038;
        }

        body {
            font-family: 'Google Sans', 'Segoe UI', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            display: flex;
            justify-content: center;
            padding: 30px;
            height: 100vh;
            box-sizing: border-box;
        }

        .container {
            width: 1200px;
            display: grid;
            grid-template-columns: 350px 1fr 350px;
            gap: 20px;
            height: 100%;
        }

        /* 通用面板样式 */
        .panel {
            background: var(--surface);
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex; flex-direction: column;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }

        .panel-header {
            padding: 16px 20px;
            background: #fff;
            border-bottom: 1px solid var(--border);
            font-weight: 500; font-size: 16px; color: var(--primary);
            display: flex; align-items: center; gap: 8px;
        }

        .panel-body {
            flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column;
        }

        /* --- 列1：全局设置 --- */
        .form-group { margin-bottom: 20px; }
        .label { font-size: 12px; font-weight: 600; color: var(--text-sub); margin-bottom: 6px; text-transform: uppercase; }
        input[type="text"] {
            width: 100%; padding: 10px 12px; border: 1px solid var(--border);
            border-radius: 6px; font-size: 14px; box-sizing: border-box; outline: none; transition: 0.2s;
        }
        input[type="text"]:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(25,103,210,0.1); }

        .saved-sets-list {
            flex: 1; border: 1px solid var(--border); border-radius: 8px;
            background: var(--bg-body); overflow-y: auto; padding: 10px; margin-top: 10px;
        }
        .saved-set-item {
            background: white; padding: 10px; margin-bottom: 8px; border-radius: 6px;
            border: 1px solid transparent; cursor: pointer; display: flex; justify-content: space-between;
        }
        .saved-set-item:hover { border-color: var(--primary); }
        .saved-set-item.active { border-color: var(--primary); background: #e8f0fe; }
        
        .set-meta { font-size: 13px; font-weight: 500; }
        .set-count { font-size: 11px; color: var(--text-sub); }

        /* --- 列2：当前套装编辑 --- */
        .search-box { position: relative; margin-bottom: 15px; }
        .dropdown {
            position: absolute; top: 45px; left: 0; right: 0;
            background: white; border: 1px solid var(--border);
            border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 300px; overflow-y: auto; display: none; z-index: 100;
        }
        .dropdown-item {
            padding: 10px 15px; cursor: pointer; font-size: 13px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #f1f3f4;
        }
        .dropdown-item:hover { background: var(--hover); color: var(--primary); }
        .dropdown-item.added { background: #e6f4ea; color: var(--success); }

        .current-items { flex: 1; overflow-y: auto; }
        .edit-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 10px; border-bottom: 1px solid #f1f3f4;
            background: white; margin-bottom: 4px; border-radius: 4px;
        }
        .edit-name { font-size: 13px; flex: 1; }
        .edit-ctrl { display: flex; align-items: center; gap: 5px; }
        .qty-input {
            width: 30px; text-align: center; border: 1px solid var(--border);
            border-radius: 4px; padding: 2px; font-size: 12px;
        }
        .btn-icon {
            color: var(--text-sub); cursor: pointer; padding: 4px; border-radius: 4px;
            display: flex; align-items: center;
        }
        .btn-icon:hover { background: var(--hover); color: #d93025; }

        .btn-primary {
            width: 100%; padding: 12px; background: var(--primary); color: white;
            border: none; border-radius: 8px; font-weight: 500; cursor: pointer;
            margin-top: 20px; display: flex; justify-content: center; gap: 8px;
        }
        .btn-primary:hover { background: #185abc; }
        .btn-secondary { background: white; color: var(--text-main); border: 1px solid var(--border); margin-top: 10px; }
        .btn-secondary:hover { background: var(--hover); }

        /* --- 列3：代码生成 --- */
        textarea {
            flex: 1; width: 100%; resize: none; border: none; outline: none;
            background: #282c34; color: #abb2bf; padding: 15px; border-radius: 8px;
            font-family: 'Consolas', monospace; font-size: 12px; line-height: 1.5;
            box-sizing: border-box; margin-bottom: 15px;
        }
        .hint { font-size: 12px; color: var(--text-sub); line-height: 1.5; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    
    <!-- 1. 全局管理 -->
    <div class="panel">
        <div class="panel-header">
            <span class="material-icons-round">folder_open</span> Set Manager
        </div>
        <div class="panel-body">
            <div class="form-group">
                <div class="label">Category Name (分类名称)</div>
                <input type="text" id="catInput" placeholder="e.g. 710HQ (战斗精英)">
            </div>
            
            <div class="label">Saved Sets (已保存职业)</div>
            <div class="saved-sets-list" id="savedList">
                <div style="text-align:center;color:#999;font-size:12px;padding:20px;">暂无保存的套装</div>
            </div>

            <button class="btn-primary" style="background:#188038" onclick="startNewSet()">
                <span class="material-icons-round">add</span> New Set (新增职业)
            </button>
        </div>
    </div>

    <!-- 2. 当前编辑 -->
    <div class="panel">
        <div class="panel-header">
            <span class="material-icons-round">edit</span> Current Editor
        </div>
        <div class="panel-body">
            <div class="form-group">
                <div class="label">Set Name (职业名称)</div>
                <input type="text" id="setNameInput" placeholder="e.g. 吟游诗人 (Bard)">
            </div>

            <div class="label">Add Items (搜索添加)</div>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search prefix..." autocomplete="off">
                <div id="dropdown" class="dropdown"></div>
            </div>

            <div class="current-items" id="itemList"></div>

            <button class="btn-primary" onclick="saveCurrentSet()">
                <span class="material-icons-round">save</span> Save to List (保存当前)
            </button>
        </div>
    </div>

    <!-- 3. 输出 -->
    <div class="panel">
        <div class="panel-header">
            <span class="material-icons-round">code</span> JSON Output
        </div>
        <div class="panel-body">
            <textarea id="output" readonly placeholder="代码将显示在这里..."></textarea>
            
            <button class="btn-primary" onclick="generateFinalJSON()">
                <span class="material-icons-round">download</span> Generate Full JSON
            </button>
            <button class="btn-primary btn-secondary" onclick="copyCode()">
                <span class="material-icons-round">content_copy</span> Copy Code
            </button>

            <div class="hint">
                <strong>使用流程：</strong><br>
                1. 填写左侧的“分类名称”。<br>
                2. 在中间编辑一个职业（如诗人），添加装备并调整数量，点“保存”。<br>
                3. 点击左侧“New Set”，再编辑下一个职业（如机工），点“保存”。<br>
                4. 所有职业都弄好后，点右侧“Generate”，一键生成整块代码。
            </div>
        </div>
    </div>

</div>

<script>
    let allRecipes = [];
    
    // 数据结构：存储所有已保存的套装
    // sets = [ { name: "诗人", items: [ {name:"弓", qty:1}, {name:"戒", qty:2} ] }, ... ]
    let savedSets = [];
    
    // 当前正在编辑的套装
    let currentItems = []; // [ {name: "弓", qty: 1}, ... ]

    fetch('recipes.json').then(r => r.json()).then(data => {
        allRecipes = data;
    });

    // --- 中间：搜索与编辑逻辑 ---
    const searchInput = document.getElementById('searchInput');
    const dropdown = document.getElementById('dropdown');
    const itemList = document.getElementById('itemList');

    searchInput.addEventListener('input', (e) => {
        const val = e.target.value.trim();
        dropdown.innerHTML = '';
        if (!val) { dropdown.style.display = 'none'; return; }

        const matches = allRecipes.filter(r => r.name.includes(val)).slice(0, 15);
        if (matches.length > 0) {
            dropdown.style.display = 'block';
            matches.forEach(r => {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                div.innerHTML = `<span>${r.name}</span> <span style="font-size:10px;color:#999">Click to Add</span>`;
                div.onclick = (event) => {
                    event.stopPropagation();
                    addItemToCurrent(r.name, div);
                };
                dropdown.appendChild(div);
            });
        } else { dropdown.style.display = 'none'; }
    });

    document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });

    function addItemToCurrent(name, element) {
        // 如果已存在，数量+1
        const exist = currentItems.find(i => i.name === name);
        if (exist) {
            exist.qty++;
        } else {
            currentItems.push({ name: name, qty: 1 });
        }
        renderCurrentList();
        if (element) element.classList.add('added');
    }

    function updateItemQty(index, val) {
        const v = parseInt(val);
        if (v > 0) {
            currentItems[index].qty = v;
        } else {
            currentItems.splice(index, 1);
        }
        renderCurrentList();
    }

    function removeItem(index) {
        currentItems.splice(index, 1);
        renderCurrentList();
    }

    function renderCurrentList() {
        if (currentItems.length === 0) {
            itemList.innerHTML = '<div style="text-align:center;color:#999;font-size:12px;margin-top:20px;">Empty list</div>';
            return;
        }
        itemList.innerHTML = '';
        currentItems.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'edit-row';
            div.innerHTML = `
                <div class="edit-name">${item.name}</div>
                <div class="edit-ctrl">
                    <input type="number" class="qty-input" value="${item.qty}" onchange="updateItemQty(${index}, this.value)">
                    <div class="btn-icon" onclick="removeItem(${index})">
                        <span class="material-icons-round" style="font-size:16px">close</span>
                    </div>
                </div>
            `;
            itemList.appendChild(div);
        });
    }

    // --- 左侧：套装管理逻辑 ---
    function startNewSet() {
        document.getElementById('setNameInput').value = '';
        currentItems = [];
        renderCurrentList();
        // 取消高亮
        document.querySelectorAll('.saved-set-item').forEach(el => el.classList.remove('active'));
    }

    function saveCurrentSet() {
        const name = document.getElementById('setNameInput').value.trim();
        if (!name) { alert("Please enter Set Name first!"); return; }
        if (currentItems.length === 0) { alert("Please add at least one item!"); return; }

        // 深拷贝一份
        const newItem = {
            name: name,
            items: JSON.parse(JSON.stringify(currentItems))
        };

        // 检查是更新还是新增 (这里简单处理为：追加到列表)
        // 也可以做更复杂的逻辑，这里为了小白方便，直接 push
        savedSets.push(newItem);
        
        renderSavedSets();
        startNewSet(); // 保存后自动清空，准备下一个
    }

    function removeSavedSet(index) {
        savedSets.splice(index, 1);
        renderSavedSets();
    }

    function loadSavedSet(index) {
        const set = savedSets[index];
        document.getElementById('setNameInput').value = set.name;
        currentItems = JSON.parse(JSON.stringify(set.items));
        renderCurrentList();
        renderSavedSets(); // 刷新高亮状态
    }

    function renderSavedSets() {
        const list = document.getElementById('savedList');
        if (savedSets.length === 0) {
            list.innerHTML = '<div style="text-align:center;color:#999;font-size:12px;padding:20px;">暂无保存的套装</div>';
            return;
        }
        list.innerHTML = '';
        savedSets.forEach((set, index) => {
            const div = document.createElement('div');
            div.className = 'saved-set-item';
            div.innerHTML = `
                <div>
                    <div class="set-meta">${set.name}</div>
                    <div class="set-count">${set.items.length} 种物品</div>
                </div>
                <div class="btn-icon" onclick="event.stopPropagation(); removeSavedSet(${index})">
                    <span class="material-icons-round" style="font-size:16px">delete</span>
                </div>
            `;
            div.onclick = () => loadSavedSet(index);
            list.appendChild(div);
        });
    }

    // --- 右侧：生成逻辑 ---
    function generateFinalJSON() {
        const cat = document.getElementById('catInput').value.trim();
        if (!cat) { alert("请填写左上角的分类名称 (Category Name)！"); return; }
        if (savedSets.length === 0) { alert("请至少保存一个套装 (Save to List)！"); return; }

        // 构造最终数据结构
        // 需要把带有 qty 的 items 展开成扁平数组
        const finalSets = savedSets.map(set => {
            let flatItems = [];
            set.items.forEach(item => {
                for (let i = 0; i < item.qty; i++) {
                    flatItems.push(item.name);
                }
            });
            return {
                name: set.name,
                items: flatItems
            };
        });

        const finalObj = {
            category: cat,
            sets: finalSets
        };

        const output = document.getElementById('output');
        output.value = JSON.stringify(finalObj, null, 2);
    }

    function copyCode() {
        const output = document.getElementById('output');
        if (!output.value) return;
        output.select();
        document.execCommand('copy');
        alert("已复制！请粘贴到 gear_sets.json 的末尾 (注意逗号)。");
    }

</script>

</body>
</html>
